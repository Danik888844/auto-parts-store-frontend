# Продажи (Sale): цикл статусов и API для фронтенда

## Статусы продажи

| Значение enum | Число | Описание |
|---------------|--------|----------|
| `Draft`       | 1 | Черновик — продажа создана, остатки не списаны |
| `Completed`   | 2 | Завершена — остатки списаны, оплата проведена |
| `Cancelled`   | 3 | Отменена — черновик отменён до завершения |
| `Refunded`    | 4 | Возврат — вся сумма возвращена, остатки возвращены на склад |

Допустимые переходы:
- **Draft** → **Completed** (завершить продажу) или **Cancelled** (отменить черновик)
- **Completed** → **Refunded** (полный или частичный возврат до обнуления суммы)

---

## 1. Создание продажи — POST `/api/Sale`

**Тело запроса (JSON):**
```json
{
  "createAsDraft": false,
  "clientId": 1,
  "paymentType": 1,
  "items": [
    { "productId": 10, "quantity": 2 },
    { "productId": 20, "quantity": 1 }
  ]
}
```

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `createAsDraft` | boolean | нет (по умолчанию `false`) | `true` — создать черновик (остатки не списываются); `false` — сразу завершённая продажа |
| `clientId` | int? | нет | ID клиента; можно не передавать или `null` |
| `paymentType` | number (enum) | да | Тип оплаты (значение из вашего enum) |
| `items` | array | да | Массив позиций: `productId`, `quantity` (строго > 0) |

**Валидация на бэкенде:** минимум одна позиция; у каждой позиции `productId` > 0, `quantity` > 0; при `createAsDraft: false` проверяется наличие и достаточность остатков.

**Успешный ответ (200):** в `data` — объект продажи (`SaleDto`: id, soldAt, clientId, client, userId, user, paymentType, **status**, total, items). В `message`: `"Sale created"` или `"Draft sale created"`.

**Типичные ошибки:** 400 — не прошла валидация формы, товар не найден/неактивен, недостаточно остатков (при завершённой продаже); 404 — клиент не найден.

**Для фронта:**  
- Кнопка «Сохранить как черновик» → отправлять с `createAsDraft: true`.  
- Кнопка «Провести продажу» / «Оформить» → с `createAsDraft: false`.  
- После создания показывать `data.status` и при `Draft` давать действия «Завершить» и «Отменить».

---

## 2. Завершение черновика — POST `/api/Sale/{saleId}/complete`

**Параметры:** `saleId` — ID продажи в URL. Пользователь берётся из токена (авторизация).

**Тело:** не требуется.

**Логика:** только продажа в статусе **Draft** может быть завершена. Списываются остатки по всем позициям, создаются движения склада, статус меняется на **Completed**.

**Успешный ответ (200):** в `data` — обновлённая продажа (`SaleDto`) с `status: 2` (Completed). В `message`: `"Sale completed"`.

**Ошибки:** 404 — продажа не найдена; 400 — «Only draft sales can be completed» (не черновик) или «Sale has no items to complete», либо «Insufficient stock for product …» (не хватает остатков на момент завершения).

**Для фронта:**  
- Кнопку «Завершить» показывать только если `sale.status === 1` (Draft).  
- При 400 с текстом про недостаток остатков — показать сообщение пользователю и не менять статус; можно предложить отредактировать черновик (если будет такой функционал) или отменить.

---

## 3. Отмена черновика — POST `/api/Sale/{saleId}/cancel`

**Параметры:** `saleId` — ID продажи в URL.

**Тело:** не требуется.

**Логика:** только продажа в статусе **Draft** может быть отменена. Статус меняется на **Cancelled**, остатки не затрагиваются.

**Успешный ответ (200):** в `data` — обновлённая продажа с `status: 3` (Cancelled). В `message`: `"Sale cancelled"`.

**Ошибки:** 404 — продажа не найдена; 400 — «Only draft sales can be cancelled».

**Для фронта:**  
- Кнопку «Отменить» показывать только для продаж со статусом Draft.  
- После отмены обновить отображаемый объект продажи (или список) из `data`.

---

## 4. Полный возврат продажи — POST `/api/Sale/{saleId}/refund`

**Параметры:** `saleId` в URL. Пользователь из токена.

**Тело:** не требуется.

**Логика:** только продажа в статусе **Completed** может быть возвращена полностью. Остатки по всем позициям возвращаются на склад, создаются движения, статус продажи → **Refunded**.

**Успешный ответ (200):** в `data` — обновлённая продажа с `status: 4` (Refunded). В `message`: `"Sale refunded"`.

**Ошибки:** 404 — продажа не найдена; 400 — «Sale is already refunded» или «Only completed sales can be refunded».

**Для фронта:**  
- Кнопку «Вернуть продажу» показывать только при `sale.status === 2` (Completed).  
- Для Refunded и Draft/Cancelled кнопку не показывать.

---

## 5. Частичный возврат позиции — POST `/api/Sale/{saleId}/items/{saleItemId}/refund?quantity=0`

**Параметры:**  
- URL: `saleId`, `saleItemId`  
- Query: `quantity` (необязательно). Если 0 или не передано — возвращается вся позиция.

**Логика:** только продажа в статусе **Completed**. Возвращается указанное количество (или вся позиция); остаток возвращается на склад. Если после возврата сумма продажи обнуляется, статус продажи меняется на **Refunded**.

**Успешный ответ (200):** в `data` — обновлённая продажа (сумма и, при полном возврате всех позиций, статус обновлены). В `message`: `"Item refunded"`.

**Ошибки:** 404 — продажа или позиция не найдены; 400 — «Sale is already fully refunded», «Only completed sales can be refunded», «Nothing to refund».

**Для фронта:**  
- Действие «Вернуть позицию» / «Частичный возврат» доступно только при `sale.status === 2` (Completed).  
- В форме указать позицию и количество для возврата; при `quantity = 0` или пустом — полный возврат по этой строке.  
- После ответа обновить карточку продажи из `data` (обновлённые `items`, `total`, `status`).

---

## 6. Получение одной продажи — GET `/api/Sale/{id}`

**Ответ:** в `data` — `SaleDto` (id, soldAt, client, user, paymentType, **status**, total, items).  
Нужен для отображения статуса и кнопок (Завершить / Отменить / Вернуть) на карточке продажи.

---

## 7. Список продаж — POST `/api/Sale/list`

**Тело:** пагинация (например `pageNumber`, `viewSize`, `search`).  
**Ответ:** список продаж с полем `status` у каждой.  
На фронте по `status` можно: фильтровать список (черновики, завершённые, возвращённые), отображать бейдж статуса и отключать/показывать действия.

---

## Краткая матрица действий по статусам

| Статус    | Завершить (complete) | Отменить (cancel) | Полный возврат (refund) | Частичный возврат (refund item) |
|-----------|----------------------|-------------------|---------------------------|-----------------------------------|
| Draft     | да                   | да                | нет                       | нет                                |
| Completed | нет                  | нет               | да                        | да                                 |
| Cancelled | нет                  | нет               | нет                       | нет                                |
| Refunded  | нет                  | нет               | нет                       | нет                                |

Формат ответов всех команд — единый: при успехе `success: true`, `data` (объект или список), `message`; при ошибке `success: false`, сообщение об ошибке и при валидации — список ошибок.
